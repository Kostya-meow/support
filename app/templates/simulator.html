<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –æ–±—É—á–µ–Ω–∏—è - Support Desk</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="layout">
        <!-- –°–∞–π–¥–±–∞—Ä —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <button class="sidebar-toggle" onclick="toggleSidebar()" title="–°–≤–µ—Ä–Ω—É—Ç—å/–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                        ‚óÄ
                    </button>
                    <h1>Support Desk</h1>
                </div>
                
                <!-- –ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                    <div class="main-nav">
                        <a href="/" class="main-nav-btn">
                            <span class="btn-icon">üìã</span>
                            <span class="btn-text">–ó–∞—è–≤–∫–∏</span>
                        </a>
                        <a href="/dashboard" class="main-nav-btn">
                            <span class="btn-icon">üìä</span>
                            <span class="btn-text">–î–∞—à–±–æ—Ä–¥</span>
                        </a>
                        <a href="/admin/knowledge" class="main-nav-btn">
                            <span class="btn-icon">üìö</span>
                            <span class="btn-text">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
                        </a>
                        <a href="/simulator" class="main-nav-btn active">
                            <span class="btn-icon">ü§ñ</span>
                            <span class="btn-text">–°–∏–º—É–ª—è—Ç–æ—Ä</span>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <form method="post" action="/logout">
                    <button type="submit" class="logout-btn">
                        <span class="btn-icon">üö™</span>
                        <span class="btn-text">–í—ã–π—Ç–∏</span>
                    </button>
                </form>
            </div>
        </aside>

    <!-- Main Content -->
    <main class="dashboard-main simulator-mode">
        <div class="simulator-container">
            
            <!-- Character Selection Screen -->
            <div id="characterSelection" class="simulator-screen">
                <div class="simulator-header">
                    <h1 class="simulator-title">üéÆ –°–∏–º—É–ª—è—Ç–æ—Ä –æ–±—É—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</h1>
                    <p class="simulator-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ —Ç—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                </div>

                <div class="character-grid" id="characterGrid">
                    <!-- Characters will be loaded here -->
                </div>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="simulator-screen" style="display: none;">
                <div class="chat-panel">
                    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
                    <header class="game-header">
                        <div class="character-info" id="characterInfo">
                            <span class="character-emoji">üôÇ</span>
                            <span class="character-name">–ù–æ–≤–∏—á–æ–∫ –í–∞—Å—è</span>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-label">
                                –í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestions">5</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 20%"></div>
                            </div>
                        </div>
                        
                        <div class="score-display">
                            –ë–∞–ª–ª—ã: <span id="currentScore">0</span>
                        </div>
                        
                        <button class="btn-end-game" id="endGameBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            –ó–∞–≤–µ—Ä—à–∏—Ç—å
                        </button>
                    </header>

                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ - —Å–∫—Ä–æ–ª–ª—è—â–∞—è—Å—è –æ–±–ª–∞—Å—Ç—å -->
                    <div class="messages" id="chatMessages">
                        <!-- Messages will appear here -->
                    </div>
                    
                    <!-- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ - –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É -->
                    <form class="reply-form" id="answerForm" autocomplete="off">
                        <div class="answer-input-wrapper">
                            <textarea 
                                id="answerInput" 
                                class="answer-input" 
                                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..."
                                rows="2"
                            ></textarea>
                            
                            <div class="answer-actions">
                                <button type="button" class="btn-hint" id="hintBtn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    –ü–æ–¥—Å–∫–∞–∑–∫–∞
                                </button>
                                
                                <button type="submit" class="btn-submit" id="submitBtn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="resultsScreen" class="simulator-screen" style="display: none;">
                <div class="results-wrapper">
                    <div class="results-header">
                        <h2 class="results-title">üéâ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                        
                        <div class="results-stats">
                            <div class="result-stat">
                                <div class="result-stat-value" id="finalScore">0</div>
                                <div class="result-stat-label">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</div>
                            </div>
                            
                            <div class="result-stat">
                                <div class="result-stat-value" id="avgScore">0</div>
                                <div class="result-stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                            </div>
                            
                            <div class="result-stat">
                                <div class="result-stat-value" id="questionsAnswered">0</div>
                                <div class="result-stat-label">–í–æ–ø—Ä–æ—Å–æ–≤</div>
                            </div>
                        </div>
                    </div>

                    <div class="results-content">
                        <h3 class="results-section-title">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
                        <div class="results-history" id="resultsHistory">
                            <!-- Detailed history will appear here -->
                        </div>
                    </div>

                    <div class="results-footer">
                        <button class="btn-primary btn-large" id="restartBtn">
                            –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // State
        let currentSession = null;
        let currentQuestion = null;

        // DOM Elements
        const characterSelection = document.getElementById('characterSelection');
        const gameScreen = document.getElementById('gameScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const characterGrid = document.getElementById('characterGrid');
        
        const characterInfo = document.getElementById('characterInfo');
        const currentQuestionEl = document.getElementById('currentQuestion');
        const totalQuestionsEl = document.getElementById('totalQuestions');
        const progressFill = document.getElementById('progressFill');
        const currentScoreEl = document.getElementById('currentScore');
        
        const chatMessages = document.getElementById('chatMessages');
        const answerInput = document.getElementById('answerInput');
        const answerForm = document.getElementById('answerForm');
        const hintBtn = document.getElementById('hintBtn');
        const submitBtn = document.getElementById('submitBtn');
        const endGameBtn = document.getElementById('endGameBtn');
        const restartBtn = document.getElementById('restartBtn');

        // Load characters on page load
        async function loadCharacters() {
            try {
                const response = await fetch('/api/simulator/characters');
                const data = await response.json();
                
                characterGrid.innerHTML = '';
                
                for (const [key, char] of Object.entries(data.characters)) {
                    const card = document.createElement('div');
                    card.className = 'character-card';
                    card.innerHTML = `
                        <div class="character-emoji-large">${char.emoji}</div>
                        <h3 class="character-card-name">${char.name}</h3>
                        <p class="character-card-description">${char.description}</p>
                        <button class="btn-primary" onclick="startSession('${key}')">
                            –í—ã–±—Ä–∞—Ç—å
                        </button>
                    `;
                    characterGrid.appendChild(card);
                }
            } catch (error) {
                console.error('Failed to load characters:', error);
                characterGrid.innerHTML = '<p class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</p>';
            }
        }

        // Start new session
        async function startSession(character) {
            try {
                // Switch to game screen immediately
                characterSelection.style.display = 'none';
                gameScreen.style.display = 'block';
                resultsScreen.style.display = 'none';
                
                // Show loading message
                chatMessages.innerHTML = '';
                addTypingIndicator();
                
                const response = await fetch('/api/simulator/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({character})
                });
                
                const data = await response.json();
                currentSession = data;
                
                // Update UI
                characterInfo.querySelector('.character-emoji').textContent = data.character_info.emoji;
                characterInfo.querySelector('.character-name').textContent = data.character_info.name;
                totalQuestionsEl.textContent = data.questions_total;
                currentQuestionEl.textContent = data.current_question;
                progressFill.style.width = `${(data.current_question / data.questions_total) * 100}%`;
                currentScoreEl.textContent = '0';
                
                // Remove typing indicator and show first question
                removeTypingIndicator();
                chatMessages.innerHTML = '';
                addMessage('user', data.question);
                
                answerInput.value = '';
                answerInput.focus();
                // answerContainer –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–π, –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
                
            } catch (error) {
                console.error('Failed to start session:', error);
                removeTypingIndicator();
                alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Å—Å–∏–∏');
            }
        }
        
        // Add typing indicator
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message chat-message-user typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">${currentSession?.character_info?.emoji || 'üôÇ'}</div>
                <div class="message-content typing-dots">
                    <span>.</span><span>.</span><span>.</span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
        }
        
        // Remove typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        // Add message to chat
        function addMessage(sender, text, isSystem = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-message-${sender}`;
            if (isSystem) messageDiv.classList.add('chat-message-system');
            
            const emoji = sender === 'user' ? currentSession.character_info.emoji : 'üë§';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${emoji}</div>
                <div class="message-content">${text}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Submit answer
        async function submitAnswer(event) {
            if (event) {
                event.preventDefault();
            }
            
            const answer = answerInput.value.trim();
            if (!answer) {
                alert('–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç!');
                return;
            }
            
            // Add operator's answer to chat
            addMessage('operator', answer);
            
            // Disable input
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round"/></svg> –û—Ü–µ–Ω–∫–∞...';
            answerInput.disabled = true;
            
            try {
                const response = await fetch('/api/simulator/respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({answer})
                });
                
                const data = await response.json();
                
                // Show evaluation
                showEvaluation(data);
                
                // Update score
                const currentScore = parseInt(currentScoreEl.textContent);
                currentScoreEl.textContent = currentScore + data.score;
                
                // Clear input
                answerInput.value = '';
                
            } catch (error) {
                console.error('Failed to submit answer:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                answerInput.disabled = false;
            }
        }
        
        answerForm.addEventListener('submit', submitAnswer);
        
        // Enter to submit (Shift+Enter for new line)
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitAnswer();
            }
        });

        // Show evaluation results as chat messages
        function showEvaluation(data) {
            // Add score message
            const scoreEmoji = data.score >= 80 ? 'üéâ' : data.score >= 60 ? 'üëç' : 'üìù';
            addMessage('system', `${scoreEmoji} <strong>–û—Ü–µ–Ω–∫–∞: ${data.score} –±–∞–ª–ª–æ–≤</strong>`, true);
            
            // Add feedback
            addMessage('system', `üí¨ <strong>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:</strong><br>${data.feedback}`, true);
            
            // Add suggestion
            addMessage('system', `‚ú® <strong>–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong><br>${data.ai_suggestion}`, true);
            
            // Continue automatically
            if (!data.session_complete) {
                setTimeout(() => nextQuestion(data), 1500);
            } else {
                setTimeout(() => showResults(data), 1500);
            }
        }

        // Next question - automatic
        function nextQuestion(data) {
            // Update progress
            currentQuestionEl.textContent = data.current_question + 1;
            progressFill.style.width = `${((data.current_question + 1) / data.questions_total) * 100}%`;
            
            // Add new question
            addMessage('user', data.next_question);
            
            // Reset input
            answerInput.value = '';
            answerInput.disabled = false;
            answerInput.focus();
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            
            // answerContainer –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–π, –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
        }

        // Show results
        function showResults(data) {
            document.getElementById('finalScore').textContent = data.total_score;
            document.getElementById('avgScore').textContent = Math.round(data.average_score);
            document.getElementById('questionsAnswered').textContent = data.history.length;
            
            // Show detailed history
            const historyContainer = document.getElementById('resultsHistory');
            historyContainer.innerHTML = '';
            
            data.history.forEach((item, index) => {
                const scoreClass = item.score >= 80 ? 'excellent' : item.score >= 60 ? 'good' : 'poor';
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-item-header">
                        <span class="history-item-number">–í–æ–ø—Ä–æ—Å ${index + 1}</span>
                        <span class="history-item-score history-score-${scoreClass}">${item.score} –±–∞–ª–ª–æ–≤</span>
                    </div>
                    <div class="history-item-question"><strong>Q:</strong> ${item.question}</div>
                    <div class="history-item-answer"><strong>A:</strong> ${item.user_answer}</div>
                    <div class="history-item-feedback"><strong>Feedback:</strong> ${item.feedback}</div>
                `;
                historyContainer.appendChild(historyItem);
            });
            
            // Switch to results screen
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'block';
        }

        // Get hint
        hintBtn.addEventListener('click', async () => {
            try {
                hintBtn.disabled = true;
                hintBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                
                const response = await fetch('/api/simulator/hint');
                const data = await response.json();
                
                // –í—ã—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã —Å—Ä–∞–∑—É
                const currentScore = parseInt(currentScoreEl.textContent);
                currentScoreEl.textContent = currentScore - 10;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —à—Ç—Ä–∞—Ñ–µ
                addMessage('system', `üí° <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (-10 –±–∞–ª–ª–æ–≤):</strong><br>${data.hint}`, true);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                hintBtn.disabled = false;
                hintBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    –ü–æ–¥—Å–∫–∞–∑–∫–∞
                `;
                
            } catch (error) {
                console.error('Failed to get hint:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏');
                hintBtn.disabled = false;
                hintBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    –ü–æ–¥—Å–∫–∞–∑–∫–∞
                `;
            }
        });

        // End game
        endGameBtn.addEventListener('click', async () => {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/simulator/end', {method: 'POST'});
                const data = await response.json();
                
                if (data.stats) {
                    showResults(data.stats);
                } else {
                    restartGame();
                }
            } catch (error) {
                console.error('Failed to end game:', error);
                restartGame();
            }
        });

        // Restart game
        restartBtn.addEventListener('click', restartGame);

        function restartGame() {
            characterSelection.style.display = 'block';
            gameScreen.style.display = 'none';
            resultsScreen.style.display = 'none';
            currentSession = null;
            loadCharacters();
        }

        // Initialize
        loadCharacters();
        
        // Sidebar toggle function
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('collapsed');
        }
    </script>
    </div> <!-- .layout -->
</body>
</html>
