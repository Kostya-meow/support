<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π - Support Desk</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="layout">
        <!-- –°–∞–π–¥–±–∞—Ä —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h1>Support Desk</h1>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                    <nav class="sidebar-nav">
                        <a href="/" class="link-button">üìã –ó–∞—è–≤–∫–∏</a>
                        <a href="/dashboard" class="link-button">üìä –î–∞—à–±–æ—Ä–¥</a>
                        <a href="/admin/knowledge" class="link-button active primary">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</a>
                    </nav>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <form method="post" action="/logout">
                    <button type="submit" class="link-button logout">üö™ –í—ã–π—Ç–∏</button>
                </form>
            </div>
        </aside>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="chat">
            <section class="chat-panel">
                <header class="chat-panel__header">
                    <h2>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>
                    <div class="knowledge-stats-inline">
                        <span class="stat-badge">
                            <span class="stat-value" id="entryCount">{{ entry_count }}</span>
                            –∑–∞–ø–∏—Å–µ–π
                        </span>
                    </div>
                </header>
                
                <div class="messages knowledge-content">
                    <div class="knowledge-upload-section">
                        <div class="upload-info">
                            <h3>üíæ –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π</h3>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã</p>
                        </div>
                        
                        <form id="uploadForm" class="knowledge-form" enctype="multipart/form-data">
                            <div class="file-upload-wrapper">
                                <input id="fileInput" name="file" type="file" accept=".xlsx,.xls" required class="file-input">
                                <label for="fileInput" class="file-upload-label">
                                    <div class="file-upload-icon">üìé</div>
                                    <div class="file-upload-text">
                                        <span class="file-upload-title">–í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª</span>
                                        <span class="file-upload-subtitle">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ —Å—é–¥–∞</span>
                                    </div>
                                    <div class="file-upload-formats">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è .xlsx –∏ .xls</div>
                                </label>
                                <div id="fileName" class="file-name"></div>
                            </div>
                            
                            <button type="submit" class="link-button primary" id="uploadButton" style="margin: 32px auto 0 auto; display: flex; justify-content: center; align-items: center; min-width: 320px; font-size: 1.15rem;" disabled>
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É
                            </button>
                        </form>

                        <div id="uploadStatus" class="upload-status"></div>
                    </div>
                    
                    <div class="knowledge-info-section">
                        <div class="info-card">
                            <h4>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–∞–π–ª—É:</h4>
                            <ul>
                                <li>–ú–∏–Ω–∏–º—É–º –¥–≤–∞ —Å—Ç–æ–ª–±—Ü–∞: –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</li>
                                <li>–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏</li>
                                <li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã .xlsx –∏ .xls</li>
                                <li>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ–Ω–∏—Ç –≤—Å—é —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const statusLabel = document.getElementById('uploadStatus');
        const entryCountLabel = document.getElementById('entryCount');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const uploadButton = document.getElementById('uploadButton');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileName.innerHTML = `
                    <div class="selected-file">
                        <span class="file-icon">üìÑ</span>
                        <span class="file-info">
                            <span class="file-title">${file.name}</span>
                            <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                        </span>
                        <button type="button" class="file-remove" onclick="clearFile()">‚úï</button>
                    </div>
                `;
                uploadButton.disabled = false;
                uploadButton.classList.add('enabled');
            } else {
                clearFile();
            }
        });

        function clearFile() {
            fileInput.value = '';
            fileName.innerHTML = '';
            uploadButton.disabled = true;
            uploadButton.classList.remove('enabled');
        }

        // Drag & Drop
        const fileUploadLabel = document.querySelector('.file-upload-label');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadLabel.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadLabel.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadLabel.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            fileUploadLabel.classList.add('drag-over');
        }

        function unhighlight(e) {
            fileUploadLabel.classList.remove('drag-over');
        }

        fileUploadLabel.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        }
        
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!fileInput.files.length) {
                statusLabel.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π.';
                statusLabel.classList.remove('success', 'loading');
                statusLabel.classList.add('error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            statusLabel.textContent = '–ò–¥—ë—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';
            statusLabel.classList.remove('error', 'success');
            statusLabel.classList.add('loading');

            try {
                const response = await fetch('/admin/knowledge/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                });

                if (!response.ok) {
                    const detail = await response.json().catch(() => ({}));
                    throw new Error(detail.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª');
                }

                const data = await response.json();
                statusLabel.textContent = `–ì–æ—Ç–æ–≤–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.entries}`;
                statusLabel.classList.remove('error', 'loading');
                statusLabel.classList.add('success');
                fileInput.value = '';
                await refreshStats();
            } catch (error) {
                statusLabel.textContent = error.message;
                statusLabel.classList.remove('success', 'loading');
                statusLabel.classList.add('error');
            }
        });

        async function refreshStats() {
            try {
                const response = await fetch('/api/knowledge/stats', {
                    credentials: 'same-origin',
                });
                if (!response.ok) {
                    return;
                }
                const data = await response.json();
                entryCountLabel.textContent = data.total_entries;
            } catch (error) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', error);
            }
        }
    </script>
</body>
</html>
